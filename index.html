<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parser menu z DOC</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Tippy.js CSS -->
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
  <style>
    /* Zachowujemy tylko niezbƒôdne niestandardowe style */
    .dish-name {
      cursor: help;
      position: relative;
    }
  </style>
</head>

<body class="bg-light text-dark">
  <div class="container mt-4">
    <h2 class="text-center">Wczytaj menu z DOC</h2>

    <!-- Prze≈ÇƒÖczniki -->
    <div class="form-check form-switch my-3">
      <input class="form-check-input" type="checkbox" id="toggleTextarea">
      <label class="form-check-label" for="toggleTextarea">Poka≈º pole tekstowe i przycisk Konwertuj</label>
    </div>
    <div class="form-check form-switch my-3">
      <input class="form-check-input" type="checkbox" id="toggleDebug">
      <label class="form-check-label" for="toggleDebug">W≈ÇƒÖcz debugowanie</label>
    </div>
    <div class="form-check form-switch my-3">
      <input class="form-check-input" type="checkbox" id="themeToggle">
      <label class="form-check-label" for="themeToggle">Ciemny motyw</label>
    </div>

    <!-- Powiadomienia i formularze -->
    <div id="debugBox" class="alert alert-info d-none">Debugowanie aktywne</div>
    <input type="file" id="fileInput" class="form-control my-3" accept=".doc">
    <button id="convertBtn" class="btn btn-primary my-3 d-none">KONWERTUJ</button>
    <div id="loadingSpinner" class="text-center my-3 d-none">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>Przetwarzanie pliku, proszƒô czekaƒá...</p>
    </div>
    <textarea id="convertedText" class="form-control my-3 d-none" rows="10"
      placeholder="Tutaj pojawi siƒô przekonwertowany tekst"></textarea>
    <button id="generateMenuBtn" class="btn btn-success my-3">GENERUJ MENU</button>
    <div id="warningBox" class="alert alert-warning d-none">Zawarto≈õƒá pliku nie jest zgodna z oczekiwaniami!</div>

    <!-- Tabela menu -->
    <table id="menuTable" class="table table-hover">
      <thead>
        <tr>
          <th>Lp.</th>
          <th>Dzie≈Ñ miesiƒÖca</th>
          <th>Dzie≈Ñ tygodnia</th>
          <th>Pierwsze danie</th>
          <th>Wyb√≥r</th>
          <th>Drugie danie</th>
          <th>Wyb√≥r</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="7" class="text-center">
            <div id="summaryBox" class="d-flex flex-wrap justify-content-between p-2 border mt-2">
              <div class="col-6 mb-2">
                <h5>Podsumowanie Pierwszych Da≈Ñ</h5>
                <p>Ilo≈õƒá zaznaczonych pierwszych da≈Ñ: <span id="selectedFirstCoursesCount">0</span></p>
                <p>Koszt pierwszego dania:
                  <input type="number" id="firstCoursePrice" value="7.50" min="0" step="0.01"> PLN
                </p>
                <p>Ca≈Çkowity koszt pierwszych da≈Ñ: <span id="totalFirstCoursesCost">0.00</span> PLN</p>
              </div>
              <div class="col-6 mb-2">
                <h5>Podsumowanie Drugich Da≈Ñ</h5>
                <p>Ilo≈õƒá zaznaczonych drugich da≈Ñ: <span id="selectedSecondCoursesCount">0</span></p>
                <p>Koszt drugiego dania:
                  <input type="number" id="secondCoursePrice" value="15.50" min="0" step="0.01"> PLN
                </p>
                <p>Ca≈Çkowity koszt drugich da≈Ñ: <span id="totalSecondCoursesCost">0.00</span> PLN</p>
              </div>
            </div>
            <div id="totalCostAllMealsContainer" class="alert alert-info mt-3 d-none">
              <h4>Ca≈Çkowity koszt obiad√≥w w miesiƒÖcu <span id="summaryMonth"></span>:
                <span id="totalCostAllMeals">0.00</span> PLN
              </h4>
            </div>
          </td>
        </tr>
      </tfoot>
    </table>
    <button id="generateDeclarationBtn" class="btn btn-warning my-3">GENERUJ DEKLARACJƒò</button>
    <div id="declarationTableContainer" class="mt-4"></div>
    <button class="btn btn-light my-3" onclick="copyDeclarationTable()">Kopiuj tabelƒô</button>

  </div>

  <!-- Skrypty -->
  <!-- Bootstrap JS (zawiera Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Popper.js i Tippy.js -->
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
    <script src="definitions.js"></script>

  <script>
    // Elementy interfejsu
    const toggleTextareaCheckbox = document.getElementById('toggleTextarea');
    const convertedTextarea = document.getElementById('convertedText');
    const convertButton = document.getElementById('convertBtn');
    const toggleDebugCheckbox = document.getElementById('toggleDebug');
    const debugBox = document.getElementById('debugBox');
    const summaryBox = document.getElementById('summaryBox');
    const totalCostAllMealsContainer = document.getElementById('totalCostAllMealsContainer');
    const generateMenuBtn = document.getElementById('generateMenuBtn');
    const fileInput = document.getElementById('fileInput');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const themeToggle = document.getElementById('themeToggle');
    const generateDeclarationBtn = document.getElementById('generateDeclarationBtn');
generateDeclarationBtn.addEventListener('click', generateDeclaration);



function generateDeclaration() {
  const rows = [...document.querySelectorAll('#menuTable tbody tr')];
  if (rows.length === 0) {
    document.getElementById('declarationTableContainer').innerHTML = '<p>Brak danych w tabeli.</p>';
    return;
  }

  // Ustalamy rok na podstawie sekwencji ‚Äî tylko do wyliczania dni tygodnia, je≈õli potrzebne.
  let currentYear = new Date().getFullYear();
  let prevMonth = null;

  // Przypiszemy meta pola (_val, _wd, _date) do ka≈ºdego wiersza.
  rows.forEach(r => {
    const dateText = (r.cells[1] && r.cells[1].textContent) ? r.cells[1].textContent.trim() : '';
    if (!dateText) {
      r._val = '-';
      r._wd = null;
      r._date = '';
      return;
    }

    const parts = dateText.split('.');
    const dd = Number(parts[0]);
    const mm = Number(parts[1]);

    // Je≈ºeli wykryjemy "zawiniecie" miesiƒÖca (np. 12 -> 01) to inkrementujemy rok.
    if (prevMonth !== null && mm < prevMonth) {
      currentYear++;
    }
    prevMonth = mm;

    // Obliczamy dzie≈Ñ tygodnia dla poprawnej detekcji poniedzia≈Çk√≥w
    const d = new Date(currentYear, mm - 1, dd);
    const wd = d.getDay(); // 0 = niedziela, 1 = poniedzia≈Çek...

    // Warto≈õƒá v (X / 1 / 2 / 3 / -)
    let v;
    if (r.classList.contains('table-secondary')) v = 'X';
    else {
      const checkboxes = r.querySelectorAll('input[type=checkbox]');
      const cb1 = checkboxes[0] || { checked: false };
      const cb2 = checkboxes[1] || { checked: false };
      v = cb1.checked && cb2.checked ? '3' : cb1.checked ? '1' : cb2.checked ? '2' : '-';
    }

    // Zapisujemy datƒô w formacie DD.MM (bez roku ‚Äî czytelniej w deklaracji)
    const ddStr = String(dd).padStart(2, '0');
    const mmStr = String(mm).padStart(2, '0');
    r._val = v;
    r._wd = wd;
    r._date = `${ddStr}.${mmStr}`;
  });

  // Budujemy tabelƒô tygodni zaczynajƒÖc od poniedzia≈Çku na/ przed pierwszym dniem miesiƒÖca
  // UWAGA: wstawiamy style INLINE aby Word/klient pocztowy zachowa≈Ç je przy wklejeniu.
  let html = '<table border="1" style="width:100%; border-collapse:collapse; table-layout:fixed;">';
  html += '<tbody>';

  // Znajd≈∫ weekday pierwszego wiersza (pierwszego dnia miesiƒÖca w tabeli)
  const firstWd = rows[0]._wd; // zak≈Çadamy, ≈ºe parseMenu ustawi≈Ç _wd dla wszystkich dni miesiƒÖca
  const daysBackToMon = (firstWd === 0) ? 6 : (firstWd - 1); // ile dni cofnƒÖƒá, ≈ºeby trafiƒá na poniedzia≈Çek
  let startIdx = 0 - daysBackToMon; // mo≈ºe byƒá ujemny (poniedzia≈Çek przed poczƒÖtkiem miesiƒÖca)

  while (startIdx <= rows.length - 1) {
    html += '<tr>';
    for (let i = 0; i < 5; i++) { // Mon..Fri
      const idx = startIdx + i;
      // Je≈õli idx poza zakresem => dzie≈Ñ nie nale≈ºy do tego miesiƒÖca -> zostawiamy pustƒÖ kom√≥rkƒô
      if (idx < 0 || idx >= rows.length) {
        html += `<td style="border:1px solid black; padding:6px;">&nbsp;</td>`;
        continue;
      }

      const r = rows[idx];
      // Je≈õli wiersz jest z tego miesiƒÖca ‚Äî zawsze pokazujemy datƒô.
      const dateText = r._date || '';

      if (r._val === 'X') {
        // Je≈õli warto≈õƒá to X ‚Äî poka≈º DATƒò i X pod spodem (zgodnie z pro≈õbƒÖ)
        html += `<td style="border:1px solid black; padding:6px; text-align:center;">
                   <div>${dateText}</div><div style="font-weight:600;">X</div>
                 </td>`;
      } else {
        // Normalny przypadek: pokazujemy datƒô i warto≈õƒá (1/2/3/-)
        html += `<td style="border:1px solid black; padding:6px; text-align:center;">
                   <div>${dateText}</div><div>${r._val}</div>
                 </td>`;
      }
    }
    html += '</tr>';
    startIdx += 7; // skok do nastƒôpnego poniedzia≈Çku
  }

  html += '</tbody></table>';
  document.getElementById('declarationTableContainer').innerHTML = html;

  // (Opcjonalny) Debug: wy≈õwietl policzone daty i warto≈õci, je≈õli w≈ÇƒÖczone debugowanie
  if (toggleDebugCheckbox.checked) {
    const dbg = rows.map((r, i) => `${i + 1}. ${r._date} -> ${r._val} (wd=${r._wd})`).join('<br>');
    debugBox.innerHTML = 'Daty i warto≈õci:<br>' + dbg;
    debugBox.classList.remove('d-none');
  }
}






    // Obs≈Çuga widoczno≈õci pola tekstowego i przycisku
    toggleTextareaCheckbox.addEventListener('change', function () {
      convertedTextarea.classList.toggle('d-none', !this.checked);
      convertButton.classList.toggle('d-none', !this.checked);
    });

    // Obs≈Çuga debugowania
    toggleDebugCheckbox.addEventListener('change', function () {
      debugBox.classList.toggle('d-none', !this.checked);
    });

    // Obs≈Çuga motywu z wykorzystaniem Bootstrap
    function applyTheme(theme) {
      const body = document.body;
      const menuTable = document.getElementById('menuTable');
      const summaryBox = document.getElementById('summaryBox');
      const totalCostContainer = document.getElementById('totalCostAllMealsContainer');

      if (theme === 'dark') {
        // Dla body
        body.classList.replace('bg-light', 'bg-dark');
        body.classList.replace('text-dark', 'text-light');

        // Dla tabeli ‚Äì dodajemy klasƒô table-dark (domy≈õlny wyglƒÖd to brak tej klasy)
        menuTable.classList.add('table-dark');

        // Dla sekcji podsumowania
        summaryBox.classList.replace('bg-light', 'bg-dark');
        summaryBox.classList.replace('text-dark', 'text-light');
        totalCostContainer.classList.replace('bg-light', 'bg-dark');
        totalCostContainer.classList.replace('text-dark', 'text-light');

        themeToggle.checked = true;
      } else {
        // Przywracamy styl jasny dla body
        body.classList.replace('bg-dark', 'bg-light');
        body.classList.replace('text-light', 'text-dark');

        // Usuwamy klasƒô table-dark ‚Äì tabela przyjmuje domy≈õlny jasny styl
        menuTable.classList.remove('table-dark');

        // Przywracamy jasny styl dla sekcji podsumowania
        summaryBox.classList.replace('bg-dark', 'bg-light');
        summaryBox.classList.replace('text-light', 'text-dark');
        totalCostContainer.classList.replace('bg-dark', 'bg-light');
        totalCostContainer.classList.replace('text-light', 'text-dark');

        themeToggle.checked = false;
      }
    }

    themeToggle.addEventListener('change', () => {
      const theme = themeToggle.checked ? 'dark' : 'light';
      applyTheme(theme);
      localStorage.setItem('theme', theme);
    });
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);

    // Konwersja i generowanie menu
    convertButton.addEventListener('click', convertFileAndGenerateMenu);
    generateMenuBtn.addEventListener('click', () => {
      if (!toggleTextareaCheckbox.checked) {
        convertFileAndGenerateMenu();
      } else {
        const text = convertedTextarea.value;
        if (!text) {
          if (toggleDebugCheckbox.checked) {
            debugBox.textContent = "Brak przekonwertowanego tekstu do przetworzenia.";
          }
          return;
        }
        loadingSpinner.classList.remove('d-none');
        setTimeout(() => {
          parseMenu(text);
          loadingSpinner.classList.add('d-none');
        }, 100);
      }
    });

    function convertFileAndGenerateMenu() {
      const file = fileInput.files[0];
      if (!file) {
        if (toggleDebugCheckbox.checked) {
          debugBox.textContent = "Nie wybrano pliku do przes≈Çania.";
        }
        return;
      }
      const formData = new FormData();
      formData.append('file', file);
      loadingSpinner.classList.remove('d-none');
      fetch('convert.php', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.Successful) {
            convertedTextarea.value = data.TextResult;
            if (toggleDebugCheckbox.checked) {
              debugBox.textContent = "Plik zosta≈Ç pomy≈õlnie przekonwertowany.";
            }
            parseMenu(data.TextResult);
          } else {
            if (toggleDebugCheckbox.checked) {
              debugBox.textContent = `B≈ÇƒÖd konwersji: ${data.Error}`;
            }
            document.getElementById('warningBox').classList.remove('d-none');
          }
        })
        .catch(error => {
          if (toggleDebugCheckbox.checked) {
            debugBox.textContent = `B≈ÇƒÖd podczas przesy≈Çania pliku: ${error.message}`;
          }
          document.getElementById('warningBox').classList.remove('d-none');
        })
        .finally(() => {
          loadingSpinner.classList.add('d-none');
        });
    }


function parseMenu(jsonTekst) {
  try {
    const debugEnabled = toggleDebugCheckbox.checked;
    const debugLog = [];

    const dane = JSON.parse(jsonTekst);
    if (!dane || !dane.Successful || !dane.TextResult) {
      document.getElementById('warningBox').classList.remove('d-none');
      return;
    }

    const tekstMenu = dane.TextResult;
    const linie = tekstMenu.split('\n').filter(linia => linia.trim() !== '');
    const menuTableBody = document.querySelector('#menuTable tbody');
    menuTableBody.innerHTML = '';
    let lp = 1;
    const parsedDates = {};
    let monthName = '';
    let monthNumber = 0;

    for (let linia of linie) {
      linia = linia.trim();

const dateMatch = linia.match(/([A-Z≈Å≈öƒÜ≈π≈ªƒò√ì≈É]+\s+)?(\d{1,2})\.(\d{2})/i);
if (dateMatch) {
  const day = dateMatch[2].padStart(2, '0');  // dzie≈Ñ
  const month = dateMatch[3].padStart(2, '0'); // miesiƒÖc
  const dateKey = `${day}.${month}`;
  monthNumber = parseInt(month, 10);
  monthName = getMonthName(monthNumber);
  parsedDates[dateKey] = { pierwszeDanie: null, drugieDanie: null };

  if (debugEnabled) debugLog.push(`üîé Rozpoznano datƒô: ${dateKey} (${linia})`);
  continue;
}


      const lastKey = Object.keys(parsedDates).pop();
      if (lastKey && parsedDates[lastKey].pierwszeDanie === null) {
        parsedDates[lastKey].pierwszeDanie = linia;
        if (debugEnabled) debugLog.push(`üç≤ Pierwsze danie dla ${lastKey}: ${linia}`);
        continue;
      }

      if (lastKey && parsedDates[lastKey].drugieDanie === null) {
        parsedDates[lastKey].drugieDanie = linia;
        if (debugEnabled) debugLog.push(`ü•ò Drugie danie dla ${lastKey}: ${linia}`);
        continue;
      }
    }

    const today = new Date();
    const year = today.getFullYear() + (monthNumber === 12 ? 1 : 0);
    const monthString = monthNumber.toString().padStart(2, '0');
    const firstDay = new Date(year, monthNumber - 1, 1);
    const lastDay = new Date(year, monthNumber, 0);

    let currentDate = new Date(firstDay);
    while (currentDate <= lastDay) {
      const dayOfWeek = getDayOfWeekPL(currentDate.getDay());
      const dayOfMonth = currentDate.getDate().toString().padStart(2, '0');
      const dateKey = `${dayOfMonth}.${monthString}`;
      const row = menuTableBody.insertRow();
      row.insertCell().textContent = lp++;
      row.insertCell().textContent = dateKey;
      row.insertCell().textContent = dayOfWeek;
      const cellPierwsze = row.insertCell();
      const cellWyborPierwsze = row.insertCell();
      const cellDrugie = row.insertCell();
      const cellWyborDrugie = row.insertCell();

      if (parsedDates[dateKey]) {
        cellPierwsze.textContent = parsedDates[dateKey].pierwszeDanie || '';
        cellPierwsze.classList.add('dish-name');
        const checkboxPierwsze = document.createElement('input');
        checkboxPierwsze.type = 'checkbox';
        checkboxPierwsze.classList.add('form-check-input');
        checkboxPierwsze.checked = true;
        cellWyborPierwsze.appendChild(checkboxPierwsze);

        cellDrugie.textContent = parsedDates[dateKey].drugieDanie || '';
        cellDrugie.classList.add('dish-name');
        const checkboxDrugie = document.createElement('input');
        checkboxDrugie.type = 'checkbox';
        checkboxDrugie.classList.add('form-check-input');
        checkboxDrugie.checked = true;
        cellWyborDrugie.appendChild(checkboxDrugie);

        if (debugEnabled) debugLog.push(`üìÖ Dodano do tabeli: ${dateKey} (${dayOfWeek})`);
      } else {
        row.classList.add('table-secondary');
        if (debugEnabled) debugLog.push(`‚ö†Ô∏è Brak danych dla ${dateKey} (${dayOfWeek})`);
      }

      currentDate.setDate(currentDate.getDate() + 1);
    }

    document.getElementById('summaryMonth').textContent = monthName;
    summaryBox.style.display = 'flex';
    totalCostAllMealsContainer.classList.remove('d-none');
    attachSummaryListeners();
    attachTooltipListeners();

    // Wy≈õwietl debugLog
    if (debugEnabled && debugLog.length > 0) {
      debugBox.innerHTML = debugLog.join('<br>');
    }
  } catch (error) {
    document.getElementById('warningBox').classList.remove('d-none');
    if (toggleDebugCheckbox.checked) {
      debugBox.innerHTML = `‚ùå B≈ÇƒÖd parsowania:<br>${error.message}`;
    }
  }
}


    function getMonthName(monthNumber) {
      const months = ["", "stycznia", "lutego", "marca", "kwietnia", "maja", "czerwca", "lipca", "sierpnia", "wrze≈õnia", "pa≈∫dziernika", "listopada", "grudnia"];
      return months[monthNumber] || "";
    }

    function getDayOfWeekPL(dayIndex) {
      const days = ["Niedziela", "Poniedzia≈Çek", "Wtorek", "≈öroda", "Czwartek", "PiƒÖtek", "Sobota"];
      return days[dayIndex];
    }

    function attachSummaryListeners() {
      const firstCoursePriceInput = document.getElementById('firstCoursePrice');
      const secondCoursePriceInput = document.getElementById('secondCoursePrice');
      const rows = document.querySelectorAll('#menuTable tbody tr');
      const selectedFirstCoursesCountSpan = document.getElementById('selectedFirstCoursesCount');
      const totalFirstCoursesCostSpan = document.getElementById('totalFirstCoursesCost');
      const selectedSecondCoursesCountSpan = document.getElementById('selectedSecondCoursesCount');
      const totalSecondCoursesCostSpan = document.getElementById('totalSecondCoursesCost');
      const totalCostAllMealsSpan = document.getElementById('totalCostAllMeals');

      const updateSummary = () => {
        let countFirst = 0;
        let countSecond = 0;
        rows.forEach(row => {
          if (!row.classList.contains('table-secondary')) {
            const checkboxes = row.querySelectorAll('input[type="checkbox"]');
            if (checkboxes.length === 2) {
              if (checkboxes[0].checked) countFirst++;
              if (checkboxes[1].checked) countSecond++;
            }
          }
        });
        const priceFirst = parseFloat(firstCoursePriceInput.value) || 0;
        const priceSecond = parseFloat(secondCoursePriceInput.value) || 0;
        const totalFirstCost = countFirst * priceFirst;
        const totalSecondCost = countSecond * priceSecond;
        const totalAllMealsCost = totalFirstCost + totalSecondCost;
        selectedFirstCoursesCountSpan.textContent = countFirst;
        totalFirstCoursesCostSpan.textContent = totalFirstCost.toFixed(2);
        selectedSecondCoursesCountSpan.textContent = countSecond;
        totalSecondCoursesCostSpan.textContent = totalSecondCost.toFixed(2);
        totalCostAllMealsSpan.textContent = totalAllMealsCost.toFixed(2);
      };

      firstCoursePriceInput.addEventListener('input', updateSummary);
      secondCoursePriceInput.addEventListener('input', updateSummary);
      rows.forEach(row => {
        row.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', updateSummary);
        });
      });
      updateSummary();
    }

function attachTooltipListeners() {
  const debugEnabled = toggleDebugCheckbox.checked;
  const debugLog = [];

  const elements = document.querySelectorAll('.dish-name');

  elements.forEach(el => {
    const dishText = el.textContent.trim().toLowerCase();
    let matchedKey = null;

    for (const keyword in keywordDefinitions) {
      if (dishText.includes(keyword)) {
        matchedKey = keyword;
        break;
      }
    }

    if (!matchedKey && debugEnabled) {
      debugLog.push(`‚ùó Brak definicji dla dania: <strong>${dishText}</strong>`);
      el.classList.add('text-danger');
    }

    tippy(el, {
      content: matchedKey ? keywordDefinitions[matchedKey] : 'Brak definicji.',
      allowHTML: true,
      theme: localStorage.getItem('theme') === 'dark' ? 'dark' : 'light',
      placement: 'top',
    });
  });

  if (debugEnabled && debugLog.length > 0) {
    debugBox.innerHTML += '<br><br><strong>‚ö†Ô∏è Dania bez definicji:</strong><br>' + debugLog.join('<br>');
  }
}

function copyDeclarationTable() {
  const table = document.querySelector('#declarationTableContainer table');
  if (!table) {
    alert('Brak tabeli do skopiowania');
    return;
  }

  // Zawarto≈õƒá tabeli (ma ju≈º inline style z generateDeclaration)
  const tableHtml = table.outerHTML;

  // Przygotuj pe≈Çny HTML z meta i style kt√≥re Word/klient pocztowy mo≈ºe wykorzystaƒá
  const htmlDocument = `
    <!doctype html>
    <html>
      <head>
        <meta charset="utf-8">
        <style>
          /* dodatkowe zabezpieczenia styl√≥w - nie nadpisujƒÖ inline, ale pomagajƒÖ */
          table { width:100%; border-collapse:collapse; table-layout:fixed; }
          th, td { border:1px solid black; padding:6px; text-align:center; }
        </style>
      </head>
      <body>
        ${tableHtml}
      </body>
    </html>
  `;

  // Spr√≥buj zapisaƒá do schowka jako HTML (nowoczesne przeglƒÖdarki)
  if (navigator.clipboard && window.ClipboardItem) {
    navigator.clipboard.write([
      new ClipboardItem({
        "text/html": new Blob([htmlDocument], { type: "text/html" }),
        "text/plain": new Blob([table.innerText], { type: "text/plain" })
      })
    ]).then(() => {
      alert("Tabela skopiowana jako HTML. Wklej do Worda/maila (Ctrl+V).");
    }).catch(err => {
      console.error("Clipboard write failed:", err);
      fallbackCopy(htmlDocument);
    });
  } else {
    // fallback dla starych przeglƒÖdarek
    fallbackCopy(htmlDocument);
  }

  // Fallback: tworzy tymczasowy element, selekcjonuje i wykonuje execCommand('copy')
  function fallbackCopy(html) {
    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.left = '-9999px';
    container.innerHTML = html;
    document.body.appendChild(container);

    const range = document.createRange();
    range.selectNodeContents(container);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);

    try {
      document.execCommand('copy');
      alert("Tabela skopiowana (fallback). Wklej do Worda/maila.");
    } catch (err) {
      console.error('Fallback copy failed', err);
      alert("Nie uda≈Ço siƒô skopiowaƒá automatycznie. Zaznacz tabelƒô rƒôcznie i skopiuj (Ctrl+C).");
    }

    sel.removeAllRanges();
    document.body.removeChild(container);
  }
}



  </script>
</body>

</html>